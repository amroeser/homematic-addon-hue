<!DOCTYPE HTML>
<!--
HomeMatic addon to control Philips Hue Lighting

Copyright (C) 2020  Jan Schneider <oss@janschneider.net>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="js/jquery-3.3.1.min.js"></script>
	<script src="js/i18next-13.0.0.min.js"></script>
	<script src="js/jquery-i18next-1.2.1.min.js"></script>
	<script src="js/semantic-2.4.2.min.js"></script>
	<link rel="stylesheet" href="css/semantic-2.4.2.min.css" />
	<style>
	.ui.form .field.unsaved_config label {
		color: #f3711c;
	}
	.ui.form .field.unsaved_config input[type=text] {
		background: #fef9f5;
		border-color: #f3711c;
		color: #f3711c;
	}
	.ui.form .field.unsaved_config select {
		background: #fef9f5;
		border-color: #f3711c;
		color: #f3711c;
	}
	.ui.basic.unsaved_config.button {
		box-shadow: 0 0 0 1px #f3711c inset!important;
		color: #f3711c !important;
	}
	</style>
	
	<title data-i18n="title">Hue Addon</title>
	<script>
		var language = navigator.language || navigator.userLanguage;
		var config = {};
		var bridges = {};
		var lights = {};
		var groups = {};
		var scenes = {};
		var used_cuxd_device_serials = {
			d2801: [],
			d2802: []
		};
		var cuxd_device_map = [];
		var message_timer_id = null;
		var establish_link_timer_id = null;
		var sid = null;
		
		// Return 1 if a > b
		// Return -1 if a < b
		// Return 0 if a == b
		function compareVersions(a, b) {
			if (a === b) {
				return 0;
			}
			var a_components = a.split(".");
			var b_components = b.split(".");
			var len = Math.min(a_components.length, b_components.length);
			for (var i = 0; i < len; i++) {
				if (parseInt(a_components[i]) > parseInt(b_components[i])) {
					return 1;
				}
				if (parseInt(a_components[i]) < parseInt(b_components[i])) {
					return -1;
				}
			}
			if (a_components.length > b_components.length) {
				return 1;
			}
			if (a_components.length < b_components.length) {
				return -1;
			}
			return 0;
		}
		
		function get_url_vars() {
			var vars = {};
			var params = window.location.search.substring(1).split('&');
			for(var i=0; i<params.length; i++) {
				param = params[i].split('=');
				if (param.length > 1) {
					vars[param[0]] = param[1];
				}
			}
			return vars;
		}
		
		function get_url_var(name) {
			return get_url_vars()[name];
		}
		
		function display_message(type, text, millis) {
			clear_message();
			$('#message').html(text);
			$('#message-container').attr('class', 'ui ' + type + ' message visible');
			message_timer_id = setTimeout(clear_message, millis);
		}
		
		function clear_message() {
			if (message_timer_id != null) {
				clearTimeout(message_timer_id);
			}
			message_timer_id = null;
			$('#message').html('');
			$('#message-container').attr('class', 'ui message hidden');
		}
		
		function default_error_callback(xhr, ajaxOptions, thrownError) {
			console.error(xhr);
			err = thrownError;
			try {
				obj = JSON.parse(xhr.responseText);
				if (obj.error != null) {
					err = obj.error;
				}
			}
			catch(e) {
			}
			display_message('error', i18next.t('error_occurred', {'error': err}), 10000);
		}
		
		function rest(method, path, data, success_callback, error_callback, async=true) {
			if (!error_callback) {
				error_callback = default_error_callback;
			}
			if (data != null) {
				data = JSON.stringify(data);
			}
			var result = null;
			if (!async) {
				success_callback = function(data) {
					result = data;
				}
			}
			$.ajax({
				url: "rest.cgi?sid=" + sid + "&path=" + path,
				type: method,
				async: async,
				data: data,
				context: document.body,
				success: success_callback,
				error: error_callback
			});
			if (!async) {
				return result;
			}
		}
		
		function api_request(bridge_id, method, path, data, success_callback) {
			rest("POST", "/bridges/" + bridge_id + '/request', {"method": method, "path": path, "data": data}, function(data) {
				//display_message('info', data, 5000);
				if (success_callback) {
					success_callback(data);
				}
			});
		}
		
		function execute_test_command() {
			var cmd = $('#test-command').val();
			if (cmd) {
				rest("PUT", "/test-command", {"language": language, "command": cmd}, function(data) {
					$('#test-command-output').removeClass('hidden');
					if (data.exitcode == 0) {
						$('#test-command-output').removeClass('error');
						$('#test-command-output').addClass('success');
					}
					else {
						$('#test-command-output').addClass('error');
						$('#test-command-output').removeClass('success');
					}
					$('#test-command-output').html('<pre>' + data.output.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") + '</pre>');
				});
			}
		}
		
		function update_global_config_form_state() {
			var unsaved_config = false;
			$('#form-global-config').find('.field').each(function(index) {
				var inp = $(this).find('input');
				if (!inp[0]) {
					inp = $(this).find('select');
				}
				if (inp[0] && inp[0].name in config.global) {
					var value = inp.val();
					if (inp[0].type == "checkbox") {
						value = inp.prop('checked');
					}
					if (value == config.global[inp[0].name].value) {
						$(this).removeClass('unsaved_config');
					}
					else {
						unsaved_config = true;
						$(this).addClass('unsaved_config');
					}
				}
			});
			var btn = $('#submit-global-config');
			if (unsaved_config) {
				btn.removeClass('green');
				btn.addClass('unsaved_config');
			}
			else {
				btn.addClass('green');
				btn.removeClass('unsaved_config');
			}
		}
		
		function set_config_defaults() {
			var form = $('#form-global-config');
			form.form('clear');
			form.form('set values', {
				poll_state_interval: config.global.poll_state_interval.default,
				log_level: config.global.log_level.default,
				api_log: config.global.api_log.default,
				api_connect_timeout: config.global.api_connect_timeout.default,
				unreachable_update_mode: config.global.unreachable_update_mode.default,
				reflect_bri_in_rgb: config.global.reflect_bri_in_rgb.default,
				group_throttling_settings: config.global.group_throttling_settings.default,
				remove_transitiontime_when_turning_off: config.global.remove_transitiontime_when_turning_off.default
			});
			update_global_config_form_state();
		}
		
		function update_global_config(config) {
			rest("PUT", "/config/global", config, function(data) {
				get_config(function(data) {
					update_view();
				});
				display_message('success', i18next.t('config_successfully_updated'), 5000);
			});
		}
		
		function get_config(success_callback, error_callback) {
			rest("GET", "/config", null, function(data) {
				config = data;
				if (success_callback) {
					success_callback(data);
				}
				if (!config.cuxd_version) {
					setTimeout(function() {
						display_message('error', i18next.t('cuxd_not_installed'), 300000);
					}, 5000);
				}
				else if (compareVersions(config.cuxd_version, '2.4') < 0) {
					setTimeout(function() {
						display_message('error', i18next.t('cuxd_to_old', {installed_version: config.cuxd_version, minimum_verison: '2.4'}), 300000);
					}, 5000);
				}
			}, error_callback);
		}
		
		function get_bridge_config(bridge_id, success_callback, error_callback) {
			api_request(bridge_id, "GET", "config", null, function(data) {
				bridges[bridge_id] = data;
				if (success_callback) {
					success_callback(data);
				}
			}, error_callback);
		}
		
		function get_lights(bridge_id, success_callback, error_callback) {
			api_request(bridge_id, "GET", "lights", null, function(data) {
				lights[bridge_id] = data;
				if (success_callback) {
					success_callback(data);
				}
			}, error_callback);
		}
		
		function get_groups(bridge_id, success_callback, error_callback) {
			api_request(bridge_id, "GET", "groups", null, function(data) {
				groups[bridge_id] = data;
				if (success_callback) {
					success_callback(data);
				}
			}, error_callback);
		}
		
		function get_scenes(bridge_id, success_callback, error_callback) {
			api_request(bridge_id, "GET", "scenes", null, function(data) {
				scenes[bridge_id] = data;
				if (success_callback) {
					success_callback(data);
				}
			}, error_callback);
		}
		function update_view() {
			$('#bridges tbody').empty();
			config.bridges.forEach(function(bridge) {
				//console.log(bridge);
				var bedit = $('<button class="ui grey basic button">').attr('data-id', bridge.id).text(i18next.t('edit'));
				bedit.click(function() {
					edit_config_bridge(this.getAttribute('data-id'));
				});
				var bdel = $('<button class="ui red basic button">').attr('data-id', bridge.id).text(i18next.t('delete'));
				bdel.click(function() {
					$("#confirm-delete").modal({
						onApprove: function() {
							delete_config_bridge(this.getAttribute('data-id'));
						}
					}).modal('show').attr('data-id', bridge.id);
				});
				var binfo = $('<button class="ui grey basic button">').attr('data-id', bridge.id).text(i18next.t('info'));
				binfo.click(function() {
					show_bridge_info(this.getAttribute('data-id'));
				});
				var btest = $('<button class="ui blue basic button">').attr('data-id', bridge.id).text(i18next.t('test'));
				btest.click(function() {
					bridge_test(this.getAttribute('data-id'));
				});
				var bcontrol = $('<button class="ui blue basic button">').attr('data-id', bridge.id).text(i18next.t('control'));
				bcontrol.click(function() {
					open_light_control(this.getAttribute('data-id'));
				});
				$("#bridges tbody").append($('<tr>').append(
					$('<td>').text(bridge.id),
					$('<td>').text(bridge.name || ''),
					$('<td>').text(bridge.ip || ''),
					$('<td class="center aligned">').append(bedit, bdel, binfo, btest, bcontrol)
				));
			});
			
			var form = $('#form-global-config');
			form.form('clear');
			form.form('set values', {
				poll_state_interval: config.global.poll_state_interval.value,
				log_level: config.global.log_level.value,
				api_log: config.global.api_log.value,
				api_connect_timeout: config.global.api_connect_timeout.value,
				unreachable_update_mode: config.global.unreachable_update_mode.value,
				reflect_bri_in_rgb: config.global.reflect_bri_in_rgb.value,
				group_throttling_settings: config.global.group_throttling_settings.value,
				remove_transitiontime_when_turning_off: config.global.remove_transitiontime_when_turning_off.value
			});
			update_global_config_form_state();
		}
		
		function cancel_establish_link() {
			if (establish_link_timer_id != null) {
				clearTimeout(establish_link_timer_id);
			}
			establish_link_timer_id = null;
		}
		
		function establish_link() {
			console.log("establish_link");
			var form = $('#form-edit-bridge');
			var ip_or_hostname = form.form('get value', 'ip');
			var port = form.form('get value', 'port');
			if (!port) { port = '80' }
			port = parseInt(port);
			//form.addClass('loading');
			if (ip_or_hostname) {
				display_message('info', i18next.t('connecting_to_bridge'), 15000);
				rest("POST", "/establish-link", {"ip": ip_or_hostname, "port": port},
					function(config) {
						console.log("link established");
						config.bridgeid = config.bridgeid.toLowerCase();
						display_message('success', i18next.t('link_to_bridge_established', {bridgeid: config.bridgeid}), 5000);
						form.form('set values', {
							id: config.bridgeid || '',
							name: config.name || '',
							username: config.username || '',
							port: config.port || '80'
						});
						$('#submit-edit-bridge').removeClass('disabled');
					},
					function(xhr, ajaxOptions, thrownError) {
						//console.error(xhr);
						err = thrownError;
						try {
							obj = JSON.parse(xhr.responseText);
							err = obj.error;
						}
						catch(e) {
						}
						var msg = i18next.t('link_to_bridge_failed', {error: err});
						msg += '<ul>';
						msg += '<li>' + i18next.t('ensure_bridge_on_and_connected') + '</li>';
						msg += '<li>' + i18next.t('test_smartphone_app') + '</li>';
						msg += '<li>' + i18next.t('press_link_button') + '</li>';
						msg += '</ul>';
						display_message('error', msg, 15000);
						establish_link_timer_id = setTimeout(establish_link, 5000);
					}
				);
			}
		}
		
		function discover_bridges() {
			//display_message('info', i18next.t('search_bridges'), 15000);
			rest("GET", "/discover-bridges", null, function(data) {
				console.log("bridges:")
				console.log(data);
				//display_message('success', i18next.t('bridges_discovered', {count: data.length}), 1000);
				$('#discovered-bridges tbody').empty();
				data.forEach(function(bridge) {
					var badd = $('<button class="ui grey basic button">').attr('data-ip', bridge.ip).attr('data-port', bridge.port).text(i18next.t('add'));
					badd.click(function() {
						add_bridge(this.getAttribute('data-ip'), this.getAttribute('data-port'));
					});
					$("#discovered-bridges tbody").append($('<tr>').append(
						$('<td>').text(bridge.ip || ''),
						$('<td class="center aligned">').append(badd)
					));
				});
			});
		}
		
		function delete_config_bridge(id) {
			var bridges = [];
			config.bridges.forEach(function(bridge) {
				if (bridge.id == id) {
					rest("DELETE", "/config/bridge/" + bridge.id, config, function(data) {
						console.log(data);
						get_config(function(data) {
							update_view();
						});
						display_message('success', i18next.t('bridge_deleted'), 5000);
					});
				}
				else {
					bridges.push(bridge);
				}
			});
			config.bridges = bridges;
			update_view();
		}
		
		function update_config_bridge(bridge) {
			rest("PUT", "/config/bridge/" + bridge.id, bridge, function(data) {
				get_config(function(data) {
					update_view();
				});
				display_message('success', i18next.t('bridge_updated'), 5000);
			});
		}
		
		function get_used_cuxd_device_serials() {
			rest("POST", "/get-used-cuxd-device-serials", {dtype: 28, dtype2: 1},
				function(response) {
					used_cuxd_device_serials.d2801 = response;
				}
			);
			rest("POST", "/get-used-cuxd-device-serials", {dtype: 28, dtype2: 2},
				function(response) {
					used_cuxd_device_serials.d2802 = response;
				}
			);
		}
		
		function create_cuxd_device(type, bridge_id, obj_type, obj_id, obj, transitiontime) {
			$('#modal-create-cuxd-device').modal('hide');
			let serial = Math.max.apply(null, used_cuxd_device_serials.d2801);
			if (type == 'dimmer') {
				serial = Math.max.apply(null, used_cuxd_device_serials.d2802);
			}
			if ((!serial) || serial === -Infinity) {
				serial = 0;
			}
			serial += 1;
			
			data = {
				type: type,
				serial: serial,
				name: "Hue " + obj.name,
				bridge_id: bridge_id,
				obj_type: obj_type,
				obj_id: parseInt(obj_id),
				transitiontime: transitiontime
			};
			if (type == 'dimmer') {
				let ct_min = 153
				let ct_max = 500
				if (('capabilities' in obj) && ('control' in obj.capabilities) && ('ct' in obj.capabilities.control)) {
					ct_min = obj.capabilities.control.ct.min
					ct_max = obj.capabilities.control.ct.max
				}
				data.ct_min = ct_min;
				data.ct_max = ct_max;
				data.color = ((obj_type == 'group') || (('capabilities' in obj) && ('control' in obj.capabilities) && ('colorgamuttype' in obj.capabilities.control)));
			};
			
			$('#form-create-cuxd-device').data('params', data);
			
			if (type == 'dimmer') {
				$('#modal-create-cuxd-device-header').text(i18next.t('create_cuxd_dimmer'));
			}
			else if (type == 'rgbw') {
				$('#modal-create-cuxd-device-header').text(i18next.t('create_cuxd_rgbw'));
			}
			else {
				$('#modal-create-cuxd-device-header').text(i18next.t('create_cuxd_switch'));
			}
			$('#form-create-cuxd-device').form('clear')
			.form('set values', {
				name: data.name,
				serial: data.serial,
				transitiontime: data.transitiontime
			})
			$('#modal-create-cuxd-device').modal({
				allowMultiple: true,
			})
			.modal('show');
		}
		
		function edit_config_bridge(id) {
			config.bridges.forEach(function(bridge) {
				if (bridge.id == id) {
					var form = $('#form-edit-bridge');
					form.form('clear');
					form.form('set values', {
						id: bridge.id,
						name: bridge.name || '',
						ip: bridge.ip || '',
						port: bridge.port || 80,
						username: bridge.username || ''
					});
					form.find("input[name='id']").parent().css('display', 'block');
					form.find("input[name='name']").parent().css('display', 'block');
					form.find("input[name='username']").parent().css('display', 'block');
					$('#modal-edit-bridge').modal('show');
				}
			});
		}
		
		function add_bridge(ip, port=80) {
			var form = $('#form-edit-bridge');
			form.form('clear');
			form.form('set values', {
				ip: ip || '',
				port: port
			});
			form.find("input[name='id']").parent().css('display', 'none');
			form.find("input[name='username']").parent().css('display', 'none');
			$('#modal-edit-bridge').modal('show');
			$('#submit-edit-bridge').addClass('disabled');
			establish_link();
		}
		
		function object_to_table( obj) {
			var tbody = $('<tbody>');
			var keys = [];
			for (var key in obj) {
				keys.push(key);
			}
			keys.sort(function(a, b) {
				a = a.toLowerCase();
				b = b.toLowerCase();
				if (a < b) return -1;
				if (a > b) return 1;
				return 0;
			});
			for (var i=0; i < keys.length; i++) {
				tbody.append($('<tr>').append(
					$('<td>').text(keys[i]),
					$('<td>').text((typeof obj[keys[i]] === 'object') ? JSON.stringify(obj[keys[i]]) : obj[keys[i]])
				));
			};
			return $('<table class="ui celled stackable table">').append(
				$('<thead>').append('<tr>').append(
					$('<th>').text(i18next.t('name')),
					$('<th>').text(i18next.t('value'))
				),
				tbody
			);
		}
		
		function show_bridge_info(bridge_id) {
			var error_callback = function(xhr, ajaxOptions, thrownError) {
				console.error(xhr);
				$('#dimmer-bridge-info').removeClass('active');
				$('#modal-bridge-info').modal('hide');
			}
			$('#modal-bridge-info').modal('show');
			$('#dimmer-bridge-info').addClass('active');
			$('#bridge-info-content').empty();
			
			function get_mapping_div(bridge_id, type, id) {
				let ul = $('<ul>');
				cuxd_device_map.forEach(function(mapping) {
					if (mapping.bridge_id == bridge_id && mapping.type == type && mapping.id == id) {
						ul.append($('<li>').text(mapping.cuxd_device));
					}
				});
				if (ul.children().length > 0) {
					return $('<div>').append($('<h3>').text(i18next.t('mapped_cuxd_devices')), ul);
				}
			}
			
			get_cuxd_device_map(function() {
				get_bridge_config(bridge_id, function(data) {
					get_lights(bridge_id, function(data) {
						get_groups(bridge_id, function(data) {
							get_scenes(bridge_id, function(data) {
								//console.log(config);
								//console.log(lights);
								$('#dimmer-bridge-info').removeClass('active');
								$('#bridge-info-content').append($('<h2 class="ui dividing header">').text(i18next.t('bridge', {bridge_id: bridge_id})));
								$('#bridge-info-content').append(object_to_table(bridges[bridge_id]));
								$.each(lights[bridge_id], function(light_id, light) {
									//console.info(light);
									$('#bridge-info-content').append($('<h2 class="ui dividing header">').text(i18next.t('light', {light_id: light_id})));
									
									let div = get_mapping_div(bridge_id, 'light', light_id);
									if (div) {
										$('#bridge-info-content').append(div);
									}
									
									div = $('<div class="create-cuxd-dev ui blue button"><i class="sliders horizontal icon"></i>' + i18next.t('create_cuxd_rgbw') + '</div>');
									div.data('light', light);
									div.click(function() {
										create_cuxd_device('rgbw', bridge_id, 'light', light_id, $(this).data('light'));
									});
									$('#bridge-info-content').append(div);
									
									/*
									div = $('<div class="create-cuxd-dev ui blue button"><i class="sliders horizontal icon"></i>' + i18next.t('create_cuxd_dimmer') + '</div>');
									div.data('light', light);
									div.click(function() {
										create_cuxd_device('dimmer', bridge_id, 'light', light_id, $(this).data('light'));
									});
									$('#bridge-info-content').append(div);
									*/
									
									div = $('<div class="create-cuxd-dev ui blue button"><i class="toggle on icon"></i>' + i18next.t('create_cuxd_switch') + '</div>');
									div.data('light', light);
									div.click(function() {
										create_cuxd_device('switch', bridge_id, 'light', light_id, $(this).data('light'));
									});
									$('#bridge-info-content').append(div);
									
									$('#bridge-info-content').append($('<h3>').text(i18next.t('properties')));
									$('#bridge-info-content').append(object_to_table(light));
								});
								$.each(groups[bridge_id], function(group_id, group) {
									//console.info(group);
									$('#bridge-info-content').append($('<h2 class="ui dividing header">').text(i18next.t('group', {group_id: group_id})));
									
									let div = get_mapping_div(bridge_id, 'group', group_id);
									if (div) {
										$('#bridge-info-content').append(div);
									}
									
									div = $('<div class="create-cuxd-dev ui blue button"><i class="sliders horizontal icon"></i>' + i18next.t('create_cuxd_rgbw') + '</div>');
									div.data('group', group);
									div.click(function() {
										create_cuxd_device('rgbw', bridge_id, 'group', group_id, $(this).data('group'));
									});
									$('#bridge-info-content').append(div);
									
									/*
									div = $('<div class="create-cuxd-dev ui blue button"><i class="sliders horizontal icon"></i>' + i18next.t('create_cuxd_dimmer') + '</div>');
									div.data('group', group);
									div.click(function() {
										create_cuxd_device('dimmer', bridge_id, 'group', group_id, $(this).data('group'));
									});
									$('#bridge-info-content').append(div);
									*/
									
									div = $('<div class="create-cuxd-dev ui blue button"><i class="toggle on icon"></i>' + i18next.t('create_cuxd_switch') + '</div>');
									div.data('group', group);
									div.click(function() {
										create_cuxd_device('switch', bridge_id, 'group', group_id, $(this).data('group'));
									});
									$('#bridge-info-content').append(div);
									
									$('#bridge-info-content').append($('<h3>').text(i18next.t('properties')));
									$('#bridge-info-content').append(object_to_table(group));
								});
								$.each(scenes[bridge_id], function(scene_id, scene) {
									//console.info(scene);
									$('#bridge-info-content').append($('<h2 class="ui dividing header">').text(i18next.t('scene', {scene_id: scene_id})));
									$('#bridge-info-content').append(object_to_table(scene));
								});
								$('#modal-bridge-info').modal('refresh');
							}, error_callback);
						}, error_callback);
					}, error_callback);
				}, error_callback);
			}, error_callback);
		}
		
		function open_light_control(bridge_id) {
			var error_callback = function(xhr, ajaxOptions, thrownError) {
				console.error(xhr);
				$('#dimmer-light-control').removeClass('active');
				$('#modal-light-control').modal('hide');
			}
			
			$('#message-light-control-request').html('');
			$('#message-light-control-request').attr('class', 'ui message hidden');
			$('#message-light-control-response').html('');
			$('#message-light-control-response').attr('class', 'ui message hidden');
			$('#message-light-control-state').html('');
			$('#message-light-control-state').attr('class', 'ui message hidden');
			$('#dimmer-light-control').addClass('active');
			$('#form-light-control').form('clear');
			$('#modal-light-control').modal('show');
			
			get_lights(bridge_id, function(data) {
				get_groups(bridge_id, function(data) {
					$('#dimmer-light-control').removeClass('active');
					$('#light-control-target').empty();
					$('#light-control-target').append('<option>');
					$.each(lights[bridge_id], function(light_id, light) {
						$('#light-control-target').append($('<option>').text(i18next.t('light_id_name', {light_id: light_id, light_name: light['name']})).data('bridge_id', bridge_id).data('light_id', light_id));
					});
					$.each(groups[bridge_id], function(group_id, group) {
						$('#light-control-target').append($('<option>').text(i18next.t('group_id_name', {group_id: group_id, group_name: group['name']})).data('bridge_id', bridge_id).data('group_id', group_id));
					});
					$('#modal-light-control').modal('refresh');
				}, error_callback);
			}, error_callback);
		}
		
		function get_control_target_state() {
			var bridge_id = $('#light-control-target').find(':selected').data('bridge_id');
			if (!bridge_id) {
				return;
			}
			var light_id = $('#light-control-target').find(':selected').data('light_id');
			var group_id = $('#light-control-target').find(':selected').data('group_id');
			var func = (light_id ? get_lights : get_groups);
			func(bridge_id, function(data) {
				var state = (light_id ? lights[bridge_id][light_id]['state'] : groups[bridge_id][group_id]['action']);
				if (state) {
					$('#message-light-control-state').html('<div class="header">' + i18next.t('status') + '</div><pre>' + JSON.stringify(state, null, 2) + '</pre>');
					$('#message-light-control-state').attr('class', 'ui message info visible');
					$('#modal-light-control').modal('refresh');
				}
			});
		}
		
		function on_submit_control() {
			var bridge_id = $('#light-control-target').find(':selected').data('bridge_id');
			if (!bridge_id) {
				return;
			}
			var light_id = $('#light-control-target').find(':selected').data('light_id');
			var group_id = $('#light-control-target').find(':selected').data('group_id');
			var resource = (light_id ? '/lights/' + light_id + '/state' : '/groups/' + group_id + '/action');
			
			var values = {};
			['on', 'bri', 'hue', 'sat', 'ct', 'xy', 'rgb', 'transitiontime', 'alert', 'effect'].forEach(function(attr) {
				var val = $('#form-light-control').form('get value', attr);
				if (val != '') {
					if (attr == 'on') {
						val = (val == 'true');
					}
					else if (attr == 'xy') {
						val = val.split(',')
						for (var i=0; i<val.length; i++) {
							val[i] = parseFloat(val[i]);
						}
					}
					else if (attr == 'rgb') {
						val = val.split(',');
						for (var i=0; i<val.length; i++) {
							val[i] = parseInt(val[i]);
						}
						while (val.length < 3) {
							val.push(0);
						}
						var color_gamut_type = null;
						if (light_id) {
							try {
								color_gamut_type = lights[bridge_id][light_id].capabilities.control.colorgamuttype;
							}
							catch(e) {
							}
						}
						res = rest("POST", "/rgb-to-xybri", {"red": val[0], "green": val[1], "blue": val[2], "color_gamut": color_gamut_type}, null, null, false);
						values['bri'] = res.bri;
						attr = 'xy';
						val = [res.x, res.y];
					}
					else if (['bri', 'hue', 'sat', 'ct', 'transitiontime'].indexOf(attr) > -1) {
						val = parseInt(val);
					}
					values[attr] = val;
				}
			});
			//console.log(values);
			$('#message-light-control-request').html('<div class="header">' + i18next.t('request') + '</div><pre>' + JSON.stringify(values, null, 2) + '</pre>');
			$('#message-light-control-request').attr('class', 'ui message info visible');
			api_request(bridge_id, "PUT", resource, values,
				function(data) {
					//console.log(data);
					var data_str = JSON.stringify(data, null, 2); // spacing level = 2
					$('#message-light-control-response').html('<div class="header">' + i18next.t('response') + '</div><pre>' + data_str + '</pre>');
					$('#message-light-control-response').attr('class', 'ui message info visible');
					$('#modal-light-control').modal('refresh');
					get_control_target_state();
				},
				function(xhr, ajaxOptions, thrownError) {
					console.error(xhr);
					$('#message-light-control-response').html(xhr);
					$('#message-light-control-response').attr('class', 'ui message error visible');
					$('#modal-light-control').modal('refresh');
					get_control_target_state();
				}
			);
		}
		
		function show_log() {
			var win = window.open('log.cgi', '_blank');
			win.focus();
		}
		
		function get_debug_data() {
			var win = window.open('debug.cgi?sid=' + sid, '_blank');
			win.focus();
		}
		
		function truncate_log() {
			rest("GET", "/truncate-log", null, function(data) {
				display_message('success', i18next.t('log_truncated'), 5000);
			});
		}
		
		function bridge_test(bridge_id) {
			api_request(bridge_id, "PUT", "/groups/0/action", {"alert":"select"});
		}
		
		function get_hued_info() {
			rest("GET", "/hued/pid", null, function(data) {
				var info = i18next.t('hued_not_running');
				if (data) {
					info = i18next.t('hued_running', {pid: data});
					$('#restart-hued-button').html('<i class="redo icon"></i>' + i18next.t('restart'));
					$("#hued-info").attr('class', 'ui message visible success');
				}
				else {
					$('#restart-hued-button').html('<i class="play icon"></i>' + i18next.t('start'));
					$("#hued-info").attr('class', 'ui message visible warning');
				}
				$("#hued-info").html(info);
				//$("#hued-info").empty();
				//$("#hued-info").append(
				//	$('<div class="sub header">').html(info)
				//);
			});
		}
		
		function restart_hued() {
			rest("PUT", "/hued/restart", null, function(data) {
				get_hued_info();
			});
		}
		
		
		function get_cuxd_device_map(callback = null, error_callback = null) {
			rest("GET", "/get-cuxd-device-map", null, function(response) {
				//console.log(response);
				response.sort(function compare(a, b) {
					if (a.cuxd_device < b.cuxd_device) {
						return -1
					}
					else if (a.cuxd_device > b.cuxd_device) {
						return 1;
					}
					return 0;
				});
				cuxd_device_map = response;
				if (callback) {
					callback();
				}
			}, error_callback);
		}
		
		function show_cuxd_device_map_info() {
			var error_callback = function(xhr, ajaxOptions, thrownError) {
				console.error(xhr);
				$('#dimmer-cuxd-device-map-info').removeClass('active');
				$('#modal-cuxd-device-map-info').modal('hide');
			}
			$('#modal-cuxd-device-map-info').modal('show');
			$('#dimmer-cuxd-device-map-info').addClass('active');
			$('#cuxd-device-map tbody').empty();
			
			get_cuxd_device_map(function() {
					cuxd_device_map.forEach(function(mapping) {
						$("#cuxd-device-map tbody").append($('<tr>').append(
							$('<td>').text(mapping.cuxd_device),
							$('<td>').text(mapping.bridge_id),
							$('<td>').text(mapping.type),
							$('<td>').text(mapping.id)
						));
					});
					$('#dimmer-cuxd-device-map-info').removeClass('active');
				}
			);
		}
		
		function init() {
			$('#content').dimmer('hide');
			
			get_config(function(data) {
				update_view();
			});
			discover_bridges();
			
			get_used_cuxd_device_serials();
			
			$('#test-command').bind("keyup", function(event) {
				if (event.keyCode === 13) {
					execute_test_command();
				}
			});
			
			rest("GET", "/version", null, function(version) {
				document.title = document.title + " " + version;
			});
			get_hued_info();
			var form_global_config = {
				fields: {
					poll_state_interval: {
						rules: [{
							type: 'integer[0..10000]',
							prompt: i18next.t('invalid_poll_interval')
						}]
					},
					log_level: {
						rules: [{
							type: 'integer[0..4]',
							prompt: i18next.t('log_level_prompt')
						}]
					},
					api_log: {
						identifier: 'api_log',
					},
					api_connect_timeout: {
						rules: [{
							type: 'integer[0..30000]',
							prompt: i18next.t('api_con_timeout_prompt')
						}]
					},
					unreachable_update_mode: {
						identifier: 'unreachable_update_mode',
					},
					reflect_bri_in_rgb: {
						identifier: 'reflect_bri_in_rgb',
					},
					group_throttling_settings: {
						identifier: 'group_throttling_settings',
						rules: [{
							type: 'regExp[/^([0-9]+\:[0-9]+,?)*$/]',
							prompt: i18next.t('group_throttling_settings_prompt')
						}]
					},
					remove_transitiontime_when_turning_off: {
						identifier: 'remove_transitiontime_when_turning_off',
						rules: [{
							type: 'regExp[(always|cuxd|never)]'
						}]
					}
				},
				onSuccess: function(event, fields) {
					var conf = $(event.currentTarget).form('get values');
					if (conf.reflect_bri_in_rgb == "on" || conf.reflect_bri_in_rgb === true) {
						conf.reflect_bri_in_rgb = true;
					}
					else {
						conf.reflect_bri_in_rgb = false;
					}
					conf.group_throttling_settings = conf.group_throttling_settings.replace(/,+$/, '');
					update_global_config(conf);
					event.preventDefault();
				}
			};
			$('#form-global-config').form(form_global_config);
			
			var form_config = {
				on: 'blur',
				fields: {
					id: {
						identifier: 'id'
					},
					name: {
						identifier: 'name',
						rules: [{
							type: 'regExp[/^[A-Za-z0-9-\. ]+$/]',
							prompt: i18next.t('name_prompt')
						}]
					},
					ip: {
						identifier: 'ip',
						rules: [{
							type: 'regExp[/^[a-z0-9-\.]+$/]',
							prompt: i18next.t('address_prompt')
						}]
					},
					port: {
						identifier: 'port',
						rules: [{
							type: 'integer[1..65535]'
						}]
					},
					username: {
						identifier: 'username'
					}
				},
				onSuccess: function(event, fields) {
					$(event.currentTarget).closest("div.modal").modal('hide');
					var bridge = $(event.currentTarget).form('get values');
					update_config_bridge(bridge);
					event.preventDefault();
				}
			};
			$('#form-edit-bridge').form(form_config);
			$('#modal-edit-bridge').modal({
				onHide: function() {
					cancel_establish_link();
					clear_message();
				}
			});
			
			$.fn.form.settings.rules.CUxDserial = function(serial) {
				var type = $('#form-create-cuxd-device').data('params').type;
				serial = parseInt(serial);
				if ((!serial) || (serial <= 0) || (serial > 999)) {
					return false;
				}
				if (type == 'dimmer') {
					return (! used_cuxd_device_serials.d2802.includes(serial));
				}
				return (! used_cuxd_device_serials.d2801.includes(serial));
			}
			var create_cuxd_device_form_config = {
				on: 'blur',
				fields: {
					name: {
						identifier: 'name',
						rules: [{
							type: 'minLength[1]',
							prompt: i18next.t('name_prompt')
						}]
					},
					serial: {
						identifier: 'serial',
						rules: [{
							type: 'CUxDserial',
							prompt: i18next.t('serial_prompt')
						}]
					},
					transitiontime: {
						identifier: 'transitiontime',
						rules: [{
							type: 'regExp[/^[0-9]*$/]',
							prompt: i18next.t('transitiontime')
						}]
					}
				},
				onSuccess: function(event, fields) {
					event.preventDefault();
					
					let data = $('#form-create-cuxd-device').data('params');
					var form = $(event.currentTarget).form('get values');
					data.serial = parseInt(form.serial);
					data.transitiontime = form.transitiontime == "" ? null : parseInt(form.transitiontime);
					data.name = form.name;
					
					$('.create-cuxd-dev').addClass('disabled');
					$('.create-cuxd-dev').addClass('loading');
					rest("POST", "/create-cuxd-device", data,
						function(response) {
							$('#modal-create-cuxd-device').modal('hide');
							$('.create-cuxd-dev').removeClass('disabled');
							$('.create-cuxd-dev').removeClass('loading');
							display_message('success', i18next.t('cuxd_device_created' ,{device: response}), 5000);
							get_used_cuxd_device_serials();
							show_bridge_info(data.bridge_id);
						},
						function(xhr, ajaxOptions, thrownError) {
							$('.create-cuxd-dev').removeClass('disabled');
							$('.create-cuxd-dev').removeClass('loading');
							default_error_callback(xhr, ajaxOptions, thrownError);
							get_used_cuxd_device_serials();
						}
					);
				}
			};
			$('#form-create-cuxd-device').form(create_cuxd_device_form_config);
		}
		
		
		$(document).ready(function() {
			
			i18next.init({
				lng: language,
				fallbackLng: 'en',
				resources: {
					en: {
						translation: {
							title: 'Hue Addon',
							error_occurred: 'An error occurred: {{error}}',
							config_successfully_updated: 'Config successfully updated',
							edit: 'edit',
							delete: 'delete',
							info: 'info',
							test: 'test',
							control: 'control',
							connecting_to_bridge: 'Connecting to bridge, please press link button..',
							link_to_bridge_established: 'Link to bridge {{bridgeid}} established',
							link_to_bridge_failed: 'Failed to establish connection to bridge: {{error}}',
							ensure_bridge_on_and_connected: 'Ensure that the Hue Bridge is turned on and connected to your network.',
							test_smartphone_app: 'Test if the smartphone app can control the lights.',
							press_link_button: 'Please press link button on Bridge.',
							search_bridges: 'Searching for Hue Bridges...',
							bridges_discovered: '{{count}} Hue Bridge(s) discovered',
							bridge_deleted: 'Hue Bridge successfully deleted',
							bridge_updated: 'Hue Bridge successfully updated',
							create_cuxd_rgbw: 'Create CUxD-RGB-dimmer',
							create_cuxd_dimmer: 'Create CUxD-dimmer',
							create_cuxd_switch: 'Create CUxD-switch',
							mapped_cuxd_devices: 'Mapped CUxD-devices:',
							bridge: 'Bridge {{bridge_id}}',
							light: 'Light {{light_id}}',
							group: 'Group {{group_id}}',
							scene: 'Scene {{scene_id}}',
							light_id_name: 'Light {{light_id}} - {{light_name}}',
							group_id_name: 'Group {{group_id}} - {{group_name}}',
							properties: 'Properties:',
							status: 'Status',
							request: 'Request',
							response: 'Response',
							log_truncated: 'Log file truncated',
							hued_not_running: 'Hue daemon is not running',
							hued_running: 'Hue daemon is running (pid: {{pid}})',
							restart: 'Restart',
							start: 'Start',
							poll_interval_prompt: 'Please enter a valid integer for the poll interval.',
							log_level_prompt: 'Please enter a valid log level.',
							group_throttling_settings_prompt: 'Please enter a valid group throttling setting.',
							api_con_timeout_prompt: 'Please enter a valid integer for the api connection timeout.',
							name_prompt: 'Please enter a valid name.',
							address_prompt: 'Please enter a valid hostname or ip address.',
							serial_prompt: 'Please enter a valid and unused serial.',
							cuxd_device_created: 'CUxD device {{device}} created',
							addon_config: 'Hue Addon configuration',
							global_config: 'Global config',
							poll_interval_label: 'Interval in seconds which specifies how often the state of devices is retrieved from the bridge (0=do not poll)',
							api_con_timeout_label: 'Timeout in milliseconds for hue api connects (0=default tcl socket behaviour)',
							log_level_label: 'Log level',
							log_hue_api_label: 'Log hue api requests and responses',
							unreachable_update_mode_label: 'How to handle status updates of unrechable devices',
							set_off: 'Treat as off',
							as_reachable: 'Treat as reachable',
							skip_update: 'Skip update',
							reflect_bri_in_rgb_label: 'Reflect the brightness in rgb values',
							group_throttling_settings_label: 'Setting for group command throttling',
							remove_transitiontime_when_turning_off_label: 'When turning off lights/groups do not send transitiontime to api',
							option_never: 'Never',
							option_cuxd: 'If triggered by CUxD',
							option_always: 'Always',
							load_config: 'Load config',
							save_config: 'Save config',
							set_config_defaults: 'Set default values',
							hue_daemon: 'Hue daemon',
							show_mappings: 'Show CUxD device mappings',
							configured_hue_bridges: 'Configured Hue Bridges',
							id: 'ID',
							name: 'Name',
							ip_address: 'IP-Address',
							action: 'Action',
							add_hue_bridge: 'Add Hue Bridge',
							discovered_hue_bridges: 'Discovered Hue Bridges',
							test_command: 'Test command',
							execute: 'Execute',
							truncate_log: 'Truncate log',
							show_log: 'Show log',
							get_debug_data: 'Get debug data',
							hue_bridge: 'Hue Bridge',
							ip_address_or_hostname: 'IP-Address or Hostname',
							port: 'Port',
							username: 'Username',
							loading: 'Loading',
							cancel: 'Cancel',
							submit: 'Submit',
							control_light_group: 'Control Light / Group',
							light_group: 'Light / Group',
							on: 'On',
							true: 'true',
							false: 'false',
							brightness: 'Brightness',
							transitiontime: 'Transitiontime',
							transitiontime_label: 'Transitiontime (multiple of 100ms, optional)',
							alert: 'Alert',
							effect: 'Effect',
							hue: 'Hue',
							saturation: 'Saturation',
							color_temperature: 'Color temperature',
							xy: 'XY',
							rgb: 'RGB',
							delete_bridge: 'Do you really want to delete this Bridge?',
							yes: 'Yes',
							no: 'No',
							info: 'Info',
							cuxd_device: 'CUxD device',
							bride_id: 'Bridge ID',
							device_tpe: 'Device type',
							device_id: 'Device ID',
							create_cuxd_device: 'Create CUxD-device',
							serial: 'Serial',
							create_device: 'Create device',
							password: 'Password',
							login: 'Login',
							value: 'Value',
							add: 'Add',
							cuxd_not_installed: 'CUx-Daemon is not installed. Please install the latest CUxD-Addon.',
							cuxd_to_old: 'Installed CUx-Daemon version {{installed_version}} is to old. Please update the CUxD-Addon to >= {{minimum_verison}}.',
						}
					},
					de: {
						translation: {
							title: 'Hue Addon',
							error_occurred: 'Ein Fehler ist aufgetreten: {{error}}',
							config_successfully_updated: 'Konfiguration erfolgreich aktualisiert',
							edit: 'Editieren',
							delete: 'Löschen',
							info: 'Info',
							test: 'Test',
							control: 'Steuern',
							connecting_to_bridge: 'Verbindung mit der Bridge wird hergestellt, bitte den Link-Button drücken..',
							link_to_bridge_established: 'Verbindung zur Bridge {{bridgeid}} hergestellt',
							link_to_bridge_failed: 'Verbindung zur Bridge fehlgeschlagen: {{error}}',
							ensure_bridge_on_and_connected: 'Stellen Sie sicher, dass die Hue Bridge eingeschaltet und mit dem Netzwerk verbunden ist.',
							test_smartphone_app: 'Testen Sie, ob die Smartphone-App die Lampen steuern kann.',
							press_link_button: 'Bitte den Link-Button der Bridge drücken.',
							search_bridges: 'Suche nach Hue Bridges...',
							bridges_discovered: '{{count}} Hue Bridge(s) gefunden',
							bridge_deleted: 'Hue Bridge erfolgreich gelöscht',
							bridge_updated: 'Hue Bridge erfolgreich aktualisiert',
							create_cuxd_rgbw: 'CUxD-RGB-Dimmer erzeugen',
							create_cuxd_dimmer: 'CUxD-Dimmer erzeugen',
							create_cuxd_switch: 'CUxD-Schalter erzeugen',
							mapped_cuxd_devices: 'Zugeordnete CUxD-Geräte:',
							bridge: 'Bridge {{bridge_id}}',
							light: 'Lampe {{light_id}}',
							group: 'Gruppe {{group_id}}',
							scene: 'Szene {{scene_id}}',
							light_id_name: 'Lampe {{light_id}} - {{light_name}}',
							group_id_name: 'Gruppe {{group_id}} - {{group_name}}',
							properties: 'Eigenschaften:',
							status: 'Status',
							request: 'Anfrage',
							response: 'Antwort',
							log_truncated: 'Log-Datei geleert',
							hued_not_running: 'Hue-Daemon läuft nicht',
							hued_running: 'Hue-Daemon läuft (pid: {{pid}})',
							restart: 'Neu starten',
							start: 'Starten',
							poll_interval_prompt: 'Bitte einen gültige Zahl für das Poll-Intervall eingeben.',
							log_level_prompt: 'Bitte einen gültigen Log-Level eingeben.',
							group_throttling_settings_prompt: 'Bitte eine gültige Einstellung für die Drosselung von Gruppen-Kommandos eingeben.',
							api_con_timeout_prompt: 'Bitte eine gültige Zahl für den API-Verbindungs-Timeout eingeben.',
							name_prompt: 'Bitte einen gültigen Namen eingeben.',
							address_prompt: 'Bitte einen gültigen Hostnamen oder eine gültige IP-Adresse eingeben.',
							serial_prompt: 'Bitte eine gültige und freie Seriennummer eingeben.',
							cuxd_device_created: 'CUxD-Gerät {{device}} angelegt',
							addon_config: 'Hue-Addon-Konfiguration',
							global_config: 'Allgemeine Konfiguration',
							poll_interval_label: 'Intervall in Sekunden, das angibt wie oft der Geräte-Status von der Bridge abgefragt wird (0=Abfrage deaktiviert)',
							api_con_timeout_label: 'Timeout in Millisekunden für API-Verbindungen (0=Standard TCL-Socket-Verhalten)',
							log_level_label: 'Log-Level',
							log_hue_api_label: 'Hue-API-Anfragen und -Antworten protokollieren',
							unreachable_update_mode_label: 'Behandlung von nicht erreichbaren Geräten bei der Status-Aktualisierung',
							set_off: 'Als aus werten',
							as_reachable: 'Wie erreichbar',
							skip_update: 'Keine Aktualisierung',
							reflect_bri_in_rgb_label: 'Helligkeitswerte in RGB-Werten widerspiegeln',
							group_throttling_settings_label: 'Einstellung für die Drosselung von Gruppen-Kommandos',
							remove_transitiontime_when_turning_off_label: 'Beim Ausschalten von Lampen/Gruppen den Parameter transitiontime nicht an die API senden',
							option_never: 'Nie',
							option_cuxd: 'Wenn von CUxD ausgelöst',
							option_always: 'Immer',
							load_config: 'Konfiguration laden',
							save_config: 'Konfiguration speichern',
							set_config_defaults: 'Standardwerte setzen',
							hue_daemon: 'Hue-Daemon',
							show_mappings: 'CUxD-Geräte-Zuordnungen anzeigen',
							configured_hue_bridges: 'Konfigurierte Hue Bridges',
							id: 'ID',
							name: 'Name',
							ip_address: 'IP-Adresse',
							action: 'Aktion',
							add_hue_bridge: 'Hue Bridge hinzufügen',
							discovered_hue_bridges: 'Gefundene Hue Bridges',
							test_command: 'Befehl testen',
							execute: 'Ausführen',
							truncate_log: 'Log leeren',
							show_log: 'Log anzeigen',
							get_debug_data: 'Debug-Daten abrufen',
							hue_bridge: 'Hue Bridge',
							ip_address_or_hostname: 'IP-Adresse oder Hostname',
							port: 'Port',
							username: 'Benutzername',
							loading: 'Lade',
							cancel: 'Abbrechen',
							submit: 'Absenden',
							control_light_group: 'Lampe / Gruppe steuern',
							light_group: 'Lampe / Gruppe',
							on: 'An',
							true: 'ja',
							false: 'nein',
							brightness: 'Helligkeit',
							transitiontime: 'Übergangszeit',
							transitiontime_label: 'Übergangszeit (in Schritten von 100ms, optional)',
							alert: 'Alarm',
							effect: 'Effekt',
							hue: 'Farbton',
							saturation: 'Sättigung',
							color_temperature: 'Farbtemperatur',
							xy: 'XY',
							rgb: 'RGB',
							delete_bridge: 'Wollen Sie die Bridge wirklich löschen?',
							yes: 'Ja',
							no: 'Nein',
							info: 'Info',
							cuxd_device: 'CUxD-Gerät',
							bride_id: 'Bridge-ID',
							device_tpe: 'Gerätetyp',
							device_id: 'Geräte-ID',
							create_cuxd_device: 'CUxD-Gerät erzeugen',
							serial: 'Seriennummer',
							create_device: 'Gerät erzeugen',
							password: 'Passwort',
							login: 'Anmeldung',
							value: 'Wert',
							add: 'Hinzufügen',
							cuxd_not_installed: 'CUx-Daemon ist nicht installiert. Bitte das neueste CUxD-Addon installieren.',
							cuxd_to_old: 'Der installierte CUx-Daemon {{installed_version}} ist zu alt. Bitte das CUxD-Addon auf >= {{minimum_verison}} aktualisieren.',
						}
					}
				}
			}, function(err, t) {
				jqueryI18next.init(i18next, $);
				$('title').localize();
				$('h1').localize();
				$('h2').localize();
				$('div').localize();
				$('th').localize();
				$('label').localize();
				$('#load-global-config').contents().last()[0].textContent = i18next.t('load_config');
				$('#set-global-config-defaults').contents().last()[0].textContent = i18next.t('set_config_defaults');
				$('#submit-global-config').contents().last()[0].textContent = i18next.t('save_config');
				$('#show-cuxd-device-map-info-button').contents().last()[0].textContent = i18next.t('show_mappings');
				$('#restart-hued-button').contents().last()[0].textContent = i18next.t('restart');
				$('#add-bridge-button').contents().last()[0].textContent = i18next.t('add_hue_bridge');
				$('#execute-test-command').contents().last()[0].textContent = i18next.t('execute');
				$('#truncate-log-button').contents().last()[0].textContent = i18next.t('truncate_log');
				$('#show-log-button').contents().last()[0].textContent = i18next.t('show_log');
				$('#get-debug-data-button').contents().last()[0].textContent = i18next.t('get_debug_data');
				$('#cancel-delete-bridge-button').contents().last()[0].textContent = i18next.t('no');
				$('#confirm-delete-bridge-button').contents().last()[0].textContent = i18next.t('yes');
			});
			
			
			$('#content').dimmer('show');
			sid = get_url_var('sid');
			rest("GET", "/get_session", null,
				function(data) {
					init();
				},
				function(xhr, ajaxOptions, thrownError) {
					if (xhr.status == 401) {
						var form_config = {
							on: 'blur',
							fields: {
								username: {
									identifier: 'username'
								},
								password: {
									identifier: 'password'
								}
							},
							onSuccess: function(event, fields) {
								event.preventDefault();
								var username = $(event.currentTarget).form('get value', 'username');
								var password = $(event.currentTarget).form('get value', 'password');
								rest("POST", "/login", {"username": username, "password": password},
									function(data) {
										window.location.href = window.location.href.replace(/\?.*/, '') + '?sid=@' + data + '@';
									},
									function(xhr, ajaxOptions, thrownError) {
										default_error_callback(xhr, ajaxOptions, thrownError);
									}
								);
							}
						};
						$('#form-login').form(form_config);
						$('#modal-login').modal('show');
					}
					else {
						default_error_callback(xhr, ajaxOptions, thrownError);
					}
				}
			);
		});
	</script>
</head>
<body>
	<div style="position: fixed; left: 50%; top: 2vh; z-index: 2000">
		<div style="position: relative; left: -50%;">
			<div class="ui container">
				<div id="message-container" class="ui message hidden" style="margin-left: 100px; margin-right: 100px; min-height: 50px; min-width: 340px">
					<i class="close icon" onclick="clear_message();"></i>
					<div id="message"></div>
				</div>
			</div>
		</div>
	</div>
	
	<div id="content" style="padding: 0; margin: 0; width: 100%">
		<div style="padding-top: 5vw" class="ui container">
			<h1 class="ui header" data-i18n="addon_config"></h1>
			
			<h2 class="ui dividing header" data-i18n="global_config"></h2>
			<form id="form-global-config" class="ui form">
				<div class="field">
					<label data-i18n="poll_interval_label"></label>
					<input name="poll_state_interval" placeholder="" type="text" onkeyup="update_global_config_form_state();" onchange="update_global_config_form_state();">
				</div>
				<div class="field">
					<label data-i18n="api_con_timeout_label"></label>
					<input name="api_connect_timeout" placeholder="" type="text" onkeyup="update_global_config_form_state();" onchange="update_global_config_form_state();">
				</div>
				<div class="field">
					<label data-i18n="log_level_label"></label>
					<select class="ui fluid search dropdown" name="log_level" onchange="update_global_config_form_state();">
						<option value="0">nothing</option>
						<option value="1">error</option>
						<option value="2">warning</option>
						<option value="3">info</option>
						<option value="4">debug</option>
					</select>
				</div>
				<div class="field">
					<label data-i18n="log_hue_api_label"></label>
					<select class="ui fluid search dropdown" name="api_log" onchange="update_global_config_form_state();">
						<option value="off">off</option>
						<option value="command">command</option>
						<option value="status">status</option>
						<option value="info">info</option>
						<option value="all">all</option>
					</select>
				</div>
				<div class="field">
					<label data-i18n="unreachable_update_mode_label"></label>
					<select class="ui fluid search dropdown" name="unreachable_update_mode" onchange="update_global_config_form_state();">
						<option value="set_off" data-i18n="set_off"></option>
						<option value="as_reachable" data-i18n="as_reachable"></option>
						<option value="skip_update" data-i18n="skip_update"></option>
					</select>
				</div>
				<div class="field">
					<label data-i18n="reflect_bri_in_rgb_label"></label>
					<div class="ui toggle checkbox">
						<input name="reflect_bri_in_rgb" type="checkbox" onchange="update_global_config_form_state();">
					</div>
				</div>
				<div class="field">
					<label data-i18n="group_throttling_settings_label"></label>
					<input name="group_throttling_settings" placeholder="num1:delay1_ms,num2:delay2_ms" type="text" onkeyup="update_global_config_form_state();" onchange="update_global_config_form_state();">
				</div>
				<div class="field">
					<label data-i18n="remove_transitiontime_when_turning_off_label"></label>
					<select class="ui fluid search dropdown" name="remove_transitiontime_when_turning_off" onchange="update_global_config_form_state();">
						<option value="never" data-i18n="option_never"></option>
						<option value="cuxd" data-i18n="option_cuxd"></option>
						<option value="always" data-i18n="option_always">always</option>
					</select>
				</div>
				<div id="load-global-config" onclick="get_config(function(data){update_view();});" class="ui blue basic button"><i class="sync icon"></i>load_config</div>
				<div id="set-global-config-defaults" onclick="set_config_defaults();" class="ui yellow basic button"><i class="undo icon"></i>set_config_defaults</div>
				<div id="submit-global-config" class="ui basic green submit button"><i class="save icon"></i>save_config</div>
			</form>
			
			<h2 class="ui dividing header" data-i18n="hue_daemon"></h2>
			<div id="hued-info" class="ui message">
			</div>
			
			<div id="show-cuxd-device-map-info-button" onclick="show_cuxd_device_map_info();" class="ui blue basic button">
				<i class="info icon"></i>
				show_mappings
			</div>
			<div id="restart-hued-button" onclick="restart_hued();" class="ui blue basic button">
				<i class="redo icon"></i>
				restart
			</div>
			
			<h2 class="ui dividing header" data-i18n="configured_hue_bridges"></h2>
			<table id="bridges" class="ui celled stackable table">
				<thead>
					<tr>
						<th data-i18n="id"></th>
						<th data-i18n="name"></th>
						<th data-i18n="ip_address"></th>
						<th class="center aligned" data-i18n="action"></th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			<div id="add-bridge-button" onclick="add_bridge();" class="ui blue basic button">
			<i class="plus icon"></i>
			add_hue_bridge
			</div>
			
			<h2 class="ui dividing header" data-i18n="discovered_hue_bridges"></h2>
			<table id="discovered-bridges" class="ui celled stackable table">
				<thead>
					<tr>
						<th data-i18n="ip_address"></th>
						<th class="center aligned" data-i18n="action"></th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			
			<h2 class="ui dividing header" data-i18n="test_command"></h2>
			<div style="width: 100%" class="ui action input">
				<input id="test-command" type="text" value="/usr/local/addons/hue/hue.tcl"/>
				<button id="execute-test-command" class="ui green right labeled icon button" onclick="execute_test_command();">
					<i class="play icon"></i>
					execute
				</button>
			</div>
			<div id="test-command-output" class="ui message hidden" style="overflow: auto"></div>
			
			<div style="margin-top:25px;" class="ui right aligned grid">
				<div class="right floated right aligned twelve wide column">
					<div id="truncate-log-button" onclick="truncate_log();" class="ui blue basic button">
						<i class="recycle icon"></i>
						truncate_log
					</div>
					<div id="show-log-button" onclick="show_log();" class="ui blue basic button">
						<i class="file text outline icon"></i>
						show_log
					</div>
					<div id="get-debug-data-button" onclick="get_debug_data();" class="ui orange basic button">
						<i class="file text outline icon"></i>
						get_debug_data
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div id="modal-edit-bridge" class="ui modal">
		<i class="close icon"></i>
		<div data-i18n="hue_bridge" class="header">
		</div>
		<div class="content">
			<form id="form-edit-bridge" class="ui form">
				<div class="disabled field">
					<label data-i18n="id"></label>
					<input name="id" placeholder="ID" type="text">
				</div>
				<div class="field">
					<label data-i18n="ip_address_or_hostname"></label>
					<input name="ip" placeholder="" type="text" onchange='establish_link();'>
				</div>
				<div class="field">
					<label data-i18n="port"></label>
					<input name="port" placeholder="" type="text" onchange='establish_link();'>
				</div>
				<div class="field">
					<label data-i18n="name"></label>
					<input name="name" placeholder="" type="text">
				</div>
				<div class="field">
					<label data-i18n="username"></label>
					<input name="username" placeholder="" type="text">
				</div>
				<div class="ui error message"></div>
				<div class="ui button" onclick="$('#modal-edit-bridge').modal('hide');" data-i18n="cancel"></div>
				<div id="submit-edit-bridge" class="ui primary submit button" data-i18n="submit"></div>
			</form>
		</div>
	</div>
	
	<div id="modal-light-control" class="ui modal">
		<i class="close icon"></i>
		<div id="dimmer-light-control" class="ui inverted dimmer">
			<div class="ui text loader" data-i18n="loading"></div>
		</div>
		<div class="header" data-i18n="control_light_group">
		</div>
		<div class="content">
			<form id="form-light-control" class="ui form">
				<div class="field">
					<label data-i18n="light_group"></label>
					<select id="light-control-target" name="target" class="ui fluid dropdown" onchange="get_control_target_state();">
						<option></option>
					</select>
				</div>
				<div class="fields">
					<div class="field">
						<label data-i18n="on"></label>
						<select name="on" class="ui fluid dropdown">
							<option value=""></option>
							<option value="true" data-i18n="true"></option>
							<option value="false" data-i18n="false"></option>
						</select>
					</div>
					<div class="field">
						<label data-i18n="brightness"></label>
						<input name="bri" placeholder="0-254" type="text">
					</div>
					<div class="field">
						<label data-i18n="transitiontime"></label>
						<input name="transitiontime" placeholder="" type="text">
					</div>
					<div class="field">
						<label data-i18n="alert"></label>
						<input name="alert" placeholder="select / lselect / none" type="text">
					</div>
					<div class="field">
						<label data-i18n="effect"></label>
						<input name="effect" placeholder="colorloop / none" type="text">
					</div>
				</div>
				<div class="fields">
					<div class="field">
						<label data-i18n="hue"></label>
						<input name="hue" placeholder="0-65535" type="text">
					</div>
					<div class="field">
						<label data-i18n="saturation"></label>
						<input name="sat" placeholder="0-254" type="text">
					</div>
					<div class="field">
						<label data-i18n="color_temperature"></label>
						<input name="ct" placeholder="153-500" type="text">
					</div>
					<div class="field">
						<label data-i18n="xy"></label>
						<input name="xy" placeholder="0.0-1.0, 0.0-1.0" type="text">
					</div>
					<div class="field">
						<label data-i18n="rgb"></label>
						<input name="rgb" placeholder="0-255,0-255,0-255" type="text">
					</div>
				</div>
				<div class="ui error message"></div>
				<div data-i18n="cancel" class="ui button" onclick="$('#modal-light-control').modal('hide');"></div>
				<div data-i18n="submit" class="ui primary submit button" onclick="on_submit_control();"></div>
			</form>
			<div id="message-light-control-state" class="ui message hidden">
			</div>
			<div id="message-light-control-request" class="ui message hidden">
			</div>
			<div id="message-light-control-response" class="ui message hidden">
			</div>
		</div>
	</div>
	
	<div class="ui dimmer modals page transition">
		<div id="confirm-delete" class="ui small basic modal transition">
			<div class="content">
				<p data-i18n="delete_bridge"></p>
			</div>
			<div class="actions">
				<div id="cancel-delete-bridge-button" class="ui red cancel inverted button">
					<i class="remove icon"></i>
				</div>
				<div id="confirm-delete-bridge-button" class="ui green ok inverted button">
					<i class="checkmark icon"></i>
				</div>
			</div>
		</div>
	</div>
	
	<div id="modal-bridge-info" class="ui modal">
		<i class="close icon"></i>
		<div id="dimmer-bridge-info" class="ui inverted dimmer">
			<div class="ui text loader" data-i18n="loading"></div>
		</div>
		<div class="header" data-i18n="info" >
		</div>
		<div id="bridge-info-content" class="content">
		</div>
	</div>
	
	<div id="modal-cuxd-device-map-info" class="ui modal">
		<i class="close icon"></i>
		<div id="dimmer-cuxd-device-map-info" class="ui inverted dimmer">
			<div class="ui text loader" data-i18n="loading"></div>
		</div>
		<div class="header" data-i18n="mapped_cuxd_devices">
		</div>
		<div class="content">
			<table id="cuxd-device-map" class="ui celled stackable table">
				<thead>
					<tr>
						<th data-i18n="cuxd_device"></th>
						<th data-i18n="bride_id"></th>
						<th data-i18n="device_tpe"></th>
						<th data-i18n="device_id"></th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>
	
	<div id="modal-create-cuxd-device" class="ui modal">
		<i class="close icon"></i>
		<div class="header" id="modal-create-cuxd-device-header" data-i18n="create_cuxd_device">
		</div>
		<div class="content">
			<form id="form-create-cuxd-device" class="ui form">
				<div class="field">
					<label data-i18n="serial"></label>
					<input type="text" name="serial">
				</div>
				<div class="field">
					<label data-i18n="name"></label>
					<input type="text" name="name">
				</div>
				<div class="field">
					<label data-i18n="transitiontime_label"></label>
					<input type="text" name="transitiontime">
				</div>
				<div class="ui error message"></div>
				<div class="ui button create-cuxd-dev" onclick="$('#modal-create-cuxd-device').modal('hide');" data-i18n="cancel"></div>
				<div id="submit-create-cuxd-device" class="ui primary submit button create-cuxd-dev" data-i18n="create_device"></div>
			</form>
		</div>
	</div>
	
	<div id="modal-login" class="ui modal">
		<i class="close icon"></i>
		<div class="header" data-i18n="login"></div>
		<div class="content">
			<form id="form-login" class="ui form">
				<div class="field">
					<label data-i18n="username"></label>
					<input type="text" name="username" value="Admin">
				</div>
				<div class="field">
					<label data-i18n="password"></label>
					<input type="password" name="password">
				</div>
				<div class="ui error message"></div>
				<div id="submit-login" class="ui primary submit button">Login</div>
			</form>
		</div>
	</div>

</body>
</html>
